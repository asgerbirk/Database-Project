name: Test CI Pipeline

on:
  workflow_dispatch: # Allows you to trigger the workflow manually

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # Upload the local .env file
      - name: Upload Local .env File
        uses: actions/upload-artifact@v3
        with:
          name: env-file
          path: .env

      # Download the .env file in the test job
      - name: Download .env File
        uses: actions/download-artifact@v3
        with:
          name: env-file

      # Load environment variables from .env
      - name: Load Environment Variables from .env
        run: |
          if [ -f .env ]; then
            echo "Loading .env file"
            export $(grep -v '^#' .env | xargs)
          else
            echo ".env file not found, skipping"
          fi

      - name: Install Dependencies
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PORT: ${{ secrets.PORT }}
          JWT_TOKEN: ${{ secrets.JWT_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI}}
        run: npm ci

      - name: Run Build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PORT: ${{ secrets.PORT }}
          JWT_TOKEN: ${{ secrets.JWT_TOKEN }}
        run: npm run build

      - name: Run Tests
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PORT: ${{ secrets.PORT }}
          JWT_TOKEN: ${{ secrets.JWT_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI}}
        run: npm run test
